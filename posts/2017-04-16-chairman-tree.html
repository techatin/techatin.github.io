<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="author" content="@katychuang" />
    <meta name="viewport" content="width=device-width" />
    <meta http-equiv="Cache-Control" content="max-age=86400, must-revalidate" />
    <title>I love Marymount JC</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="js/custom.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/default.css" />
    <link rel="stylesheet" type="text/css" href="../css/custom.css" />
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.10.0/styles/default.min.css">
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.10.0/highlight.min.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</head>

<body>
    <div class="highbar">&nbsp;</div>
    <div class="navbar navbar-default navbar-fixed-top">
        <div class="container">
            <div class="navbar-header">
                <a href="../" class="navbar-brand">Just a Blog</a>
                <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#navbar-main" aria-expanded="false">
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
            </div>
            <div class="navbar-collapse collapse" id="navbar-main" aria-expanded="false" style="height: 1px;">
                <ul class="nav navbar-nav">
                    <li>
                        <a href="../tags/index.html">Tags</a>
                    </li>
                    <li>
                        <a href="../archive.html">Archive</a>
                    </li>
                    <li>
                        <a href="../about.html"> About me </a>
                    </li>
                </ul>

                <ul class="nav navbar-nav navbar-right">
                    <li><a href="http://builtwithbootstrap.com/" target="_blank">Built With Bootstrap</a></li>
                    <li><a href="https://wrapbootstrap.com/?ref=bsw" target="_blank">WrapBootstrap</a></li>
                </ul>

            </div>
        </div>
    </div>
    <div class="container">
        <div class="row">
            <div class="page-header" id="banner">
                <div id="content" class="inside">
                    <div class="row">

    <div class="col-lg-3">
        <div class="panel panel-default" id="info">
            <div class="panel-body">
                <h3> Data Persistent Segment Tree </h3>
                <p>
                    <small>
                        Posted on April 16, 2017
                        
                            by Techatin
                        
                    </small>
                </p>
                
                    <p>
                        <small>
                            <a href="../tags/competitive%20programming.html">competitive programming</a>, <a href="../tags/data%20structures.html">data structures</a>
                        </small>
                    </p>
                
            </div>
        </div>
    </div>

    <div class="col-lg-7">
        
            <div class="well">
                <p> It's China magic, or is it? </p>
            </div>
            <hr />
        
        <p>In Singapore NOI 2015, a rather peculiar question was asked, where the contestants are supposed to perform a range <span class="math inline">\(k^{th}\)</span> largest query. The official solution presented was a somewhat obscure merge sort segment tree, which had pretty high time and space complexities. Of course, there are ways to do better than that. This article presents such a data structure called data persistent segment tree(DPST), or known affectionately by the Chinese OIers, 主席树(chairman’s tree).</p>
<!--more-->
<p>Using a DPST to solve the aforementioned problem may not be intuitive at the first glance, so we will start with the easiest case. Imagine that the query is on the whole range, but you are only allowed to use a segment tree. The idea is to build a tree on the values of the array. Each node <span class="math inline">\([l, r]\)</span> stores the information how many elements have values between <span class="math inline">\(l\)</span> and <span class="math inline">\(r\)</span> inclusive. For instance, consider the following array:</p>
<p><span class="math display">\[ r = [1, 3, 2, 4, 5, 7, 6, 8] \]</span></p>
<p>The resultant segment tree will look something like:</p>
<?xml version="1.0" encoding="UTF-8" standalone="no" ?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.38.0 (20140413.2041)
 -->
<!-- Title: G Pages: 1 -->
<svg width="432pt" height="147pt" viewBox="0.00 0.00 432.00 146.58" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(0.563753 0.563753) rotate(0) translate(4 256)">
<title>G</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-256 762.293,-256 762.293,4 -4,4"></polygon>
<!-- a -->
<g id="node1" class="node"><title>a</title>
<ellipse fill="none" stroke="black" cx="378.646" cy="-234" rx="39.7935" ry="18"></ellipse>
<text text-anchor="middle" x="378.646" y="-230.3" font-family="Times,serif" font-size="14.00">[1, 8]: 8</text>
</g>
<!-- b -->
<g id="node2" class="node"><title>b</title>
<ellipse fill="none" stroke="black" cx="281.646" cy="-162" rx="39.7935" ry="18"></ellipse>
<text text-anchor="middle" x="281.646" y="-158.3" font-family="Times,serif" font-size="14.00">[1, 4]: 4</text>
</g>
<!-- a&#45;&gt;b -->
<g id="edge1" class="edge"><title>a-&gt;b</title>
<path fill="none" stroke="black" d="M358.075,-218.155C344.092,-208.064 325.411,-194.583 310.018,-183.474"></path>
<polygon fill="black" stroke="black" points="312.013,-180.598 301.855,-177.584 307.916,-186.274 312.013,-180.598"></polygon>
</g>
<!-- c -->
<g id="node3" class="node"><title>c</title>
<ellipse fill="none" stroke="black" cx="475.646" cy="-162" rx="39.7935" ry="18"></ellipse>
<text text-anchor="middle" x="475.646" y="-158.3" font-family="Times,serif" font-size="14.00">[5, 8]: 4</text>
</g>
<!-- a&#45;&gt;c -->
<g id="edge2" class="edge"><title>a-&gt;c</title>
<path fill="none" stroke="black" d="M399.218,-218.155C413.201,-208.064 431.882,-194.583 447.275,-183.474"></path>
<polygon fill="black" stroke="black" points="449.377,-186.274 455.438,-177.584 445.28,-180.598 449.377,-186.274"></polygon>
</g>
<!-- d -->
<g id="node4" class="node"><title>d</title>
<ellipse fill="none" stroke="black" cx="136.646" cy="-90" rx="39.7935" ry="18"></ellipse>
<text text-anchor="middle" x="136.646" y="-86.3" font-family="Times,serif" font-size="14.00">[1, 2]: 2</text>
</g>
<!-- b&#45;&gt;d -->
<g id="edge3" class="edge"><title>b-&gt;d</title>
<path fill="none" stroke="black" d="M255.388,-148.324C231.983,-137.025 197.544,-120.399 171.775,-107.959"></path>
<polygon fill="black" stroke="black" points="173.237,-104.778 162.71,-103.582 170.193,-111.082 173.237,-104.778"></polygon>
</g>
<!-- e -->
<g id="node5" class="node"><title>e</title>
<ellipse fill="none" stroke="black" cx="281.646" cy="-90" rx="39.7935" ry="18"></ellipse>
<text text-anchor="middle" x="281.646" y="-86.3" font-family="Times,serif" font-size="14.00">[3, 4]: 2</text>
</g>
<!-- b&#45;&gt;e -->
<g id="edge4" class="edge"><title>b-&gt;e</title>
<path fill="none" stroke="black" d="M281.646,-143.697C281.646,-135.983 281.646,-126.712 281.646,-118.112"></path>
<polygon fill="black" stroke="black" points="285.147,-118.104 281.646,-108.104 278.147,-118.104 285.147,-118.104"></polygon>
</g>
<!-- f -->
<g id="node6" class="node"><title>f</title>
<ellipse fill="none" stroke="black" cx="475.646" cy="-90" rx="39.7935" ry="18"></ellipse>
<text text-anchor="middle" x="475.646" y="-86.3" font-family="Times,serif" font-size="14.00">[5, 6]: 2</text>
</g>
<!-- c&#45;&gt;f -->
<g id="edge5" class="edge"><title>c-&gt;f</title>
<path fill="none" stroke="black" d="M475.646,-143.697C475.646,-135.983 475.646,-126.712 475.646,-118.112"></path>
<polygon fill="black" stroke="black" points="479.147,-118.104 475.646,-108.104 472.147,-118.104 479.147,-118.104"></polygon>
</g>
<!-- g -->
<g id="node7" class="node"><title>g</title>
<ellipse fill="none" stroke="black" cx="621.646" cy="-90" rx="39.7935" ry="18"></ellipse>
<text text-anchor="middle" x="621.646" y="-86.3" font-family="Times,serif" font-size="14.00">[7, 8]: 2</text>
</g>
<!-- c&#45;&gt;g -->
<g id="edge6" class="edge"><title>c-&gt;g</title>
<path fill="none" stroke="black" d="M502.086,-148.324C525.652,-137.025 560.329,-120.399 586.276,-107.959"></path>
<polygon fill="black" stroke="black" points="587.9,-111.062 595.404,-103.582 584.873,-104.75 587.9,-111.062"></polygon>
</g>
<!-- h -->
<g id="node8" class="node"><title>h</title>
<ellipse fill="none" stroke="black" cx="39.6465" cy="-18" rx="39.7935" ry="18"></ellipse>
<text text-anchor="middle" x="39.6465" y="-14.3" font-family="Times,serif" font-size="14.00">[1, 1]: 1</text>
</g>
<!-- d&#45;&gt;h -->
<g id="edge7" class="edge"><title>d-&gt;h</title>
<path fill="none" stroke="black" d="M116.075,-74.1548C102.092,-64.064 83.4109,-50.5825 68.018,-39.4743"></path>
<polygon fill="black" stroke="black" points="70.0126,-36.5975 59.8554,-33.5838 65.9163,-42.2738 70.0126,-36.5975"></polygon>
</g>
<!-- i -->
<g id="node9" class="node"><title>i</title>
<ellipse fill="none" stroke="black" cx="136.646" cy="-18" rx="39.7935" ry="18"></ellipse>
<text text-anchor="middle" x="136.646" y="-14.3" font-family="Times,serif" font-size="14.00">[2, 2]: 1</text>
</g>
<!-- d&#45;&gt;i -->
<g id="edge8" class="edge"><title>d-&gt;i</title>
<path fill="none" stroke="black" d="M136.646,-71.6966C136.646,-63.9827 136.646,-54.7125 136.646,-46.1124"></path>
<polygon fill="black" stroke="black" points="140.147,-46.1043 136.646,-36.1043 133.147,-46.1044 140.147,-46.1043"></polygon>
</g>
<!-- j -->
<g id="node10" class="node"><title>j</title>
<ellipse fill="none" stroke="black" cx="233.646" cy="-18" rx="39.7935" ry="18"></ellipse>
<text text-anchor="middle" x="233.646" y="-14.3" font-family="Times,serif" font-size="14.00">[3, 3]: 1</text>
</g>
<!-- e&#45;&gt;j -->
<g id="edge9" class="edge"><title>e-&gt;j</title>
<path fill="none" stroke="black" d="M270.271,-72.411C264.413,-63.8677 257.152,-53.2785 250.644,-43.7874"></path>
<polygon fill="black" stroke="black" points="253.482,-41.7379 244.94,-35.4699 247.709,-45.6966 253.482,-41.7379"></polygon>
</g>
<!-- k -->
<g id="node11" class="node"><title>k</title>
<ellipse fill="none" stroke="black" cx="330.646" cy="-18" rx="39.7935" ry="18"></ellipse>
<text text-anchor="middle" x="330.646" y="-14.3" font-family="Times,serif" font-size="14.00">[4, 4]: 1</text>
</g>
<!-- e&#45;&gt;k -->
<g id="edge10" class="edge"><title>e-&gt;k</title>
<path fill="none" stroke="black" d="M293.259,-72.411C299.239,-63.8677 306.652,-53.2785 313.295,-43.7874"></path>
<polygon fill="black" stroke="black" points="316.25,-45.6694 319.118,-35.4699 310.516,-41.6552 316.25,-45.6694"></polygon>
</g>
<!-- l -->
<g id="node12" class="node"><title>l</title>
<ellipse fill="none" stroke="black" cx="427.646" cy="-18" rx="39.7935" ry="18"></ellipse>
<text text-anchor="middle" x="427.646" y="-14.3" font-family="Times,serif" font-size="14.00">[5, 5]: 1</text>
</g>
<!-- f&#45;&gt;l -->
<g id="edge11" class="edge"><title>f-&gt;l</title>
<path fill="none" stroke="black" d="M464.271,-72.411C458.413,-63.8677 451.152,-53.2785 444.644,-43.7874"></path>
<polygon fill="black" stroke="black" points="447.482,-41.7379 438.94,-35.4699 441.709,-45.6966 447.482,-41.7379"></polygon>
</g>
<!-- m -->
<g id="node13" class="node"><title>m</title>
<ellipse fill="none" stroke="black" cx="524.646" cy="-18" rx="39.7935" ry="18"></ellipse>
<text text-anchor="middle" x="524.646" y="-14.3" font-family="Times,serif" font-size="14.00">[6, 6]: 1</text>
</g>
<!-- f&#45;&gt;m -->
<g id="edge12" class="edge"><title>f-&gt;m</title>
<path fill="none" stroke="black" d="M487.259,-72.411C493.239,-63.8677 500.652,-53.2785 507.295,-43.7874"></path>
<polygon fill="black" stroke="black" points="510.25,-45.6694 513.118,-35.4699 504.516,-41.6552 510.25,-45.6694"></polygon>
</g>
<!-- n -->
<g id="node14" class="node"><title>n</title>
<ellipse fill="none" stroke="black" cx="621.646" cy="-18" rx="39.7935" ry="18"></ellipse>
<text text-anchor="middle" x="621.646" y="-14.3" font-family="Times,serif" font-size="14.00">[7, 7]: 1</text>
</g>
<!-- g&#45;&gt;n -->
<g id="edge13" class="edge"><title>g-&gt;n</title>
<path fill="none" stroke="black" d="M621.646,-71.6966C621.646,-63.9827 621.646,-54.7125 621.646,-46.1124"></path>
<polygon fill="black" stroke="black" points="625.147,-46.1043 621.646,-36.1043 618.147,-46.1044 625.147,-46.1043"></polygon>
</g>
<!-- o -->
<g id="node15" class="node"><title>o</title>
<ellipse fill="none" stroke="black" cx="718.646" cy="-18" rx="39.7935" ry="18"></ellipse>
<text text-anchor="middle" x="718.646" y="-14.3" font-family="Times,serif" font-size="14.00">[8, 8]: 1</text>
</g>
<!-- g&#45;&gt;o -->
<g id="edge14" class="edge"><title>g-&gt;o</title>
<path fill="none" stroke="black" d="M642.218,-74.1548C656.201,-64.064 674.882,-50.5825 690.275,-39.4743"></path>
<polygon fill="black" stroke="black" points="692.377,-42.2738 698.438,-33.5838 688.28,-36.5975 692.377,-42.2738"></polygon>
</g>
</g>
</svg>

<p>Where <span class="math inline">\([l, r]:k\)</span> means there are <span class="math inline">\(k\)</span> values smaller than or equal to <span class="math inline">\(r\)</span> but larger than or equal to <span class="math inline">\(l\)</span>. The solution then comes almost naturally. If the label on the right subtree is more than or equals to <span class="math inline">\(k\)</span>, we know that the answer definitely lies somewhere in the segment covered by the right subtree. Otherwise, it must be in the left subtree. More generally, the algorithm can be described using the following pesudocode (actually c++):</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp">
<span class="dt">int</span> find_kth(node n, <span class="dt">int</span> k) {
    <span class="cf">if</span> (is_leaf(n)) <span class="cf">return</span> n.label;
    <span class="cf">if</span> (n.right_child.size &gt;= k) <span class="cf">return</span> find_kth(n.right_child, k);
    <span class="cf">else</span> <span class="cf">return</span> find_kth(n.left_child, k - n.right_child.size());
}</code></pre></div>
<p>But this is quite stupid - we can just sort first, or simply iterate through and get the same result. You will see how it can extend to more complicated scenarios, such as the one below:</p>
<p>Assuming we now have to entertain all queries in the form <span class="math inline">\(&lt;1, i&gt;: k\)</span>, that is, finding the <span class="math inline">\(k^{th}\)</span> largest element between positions 1 and <span class="math inline">\(i\)</span>. Notice how the notation is different. We will use <span class="math inline">\([l, r]\)</span> to denote the range of values, and <span class="math inline">\(&lt;l, r&gt;\)</span> to denote the range of positions in the given array. We can use the same approach as above, building a segment tree for each range starting at index one. The only problem is with the ridiculous space complexity of <span class="math inline">\(\mathcal{O}(n^2\log{}n)\)</span>, where <span class="math inline">\(n\)</span> is the number of distinct elements in the array.</p>
<p>Now, the magic will start. We will use the idea of data persistence to reduce the space complexity to <span class="math inline">\(\mathcal{O}(n\log{}n)\)</span>. First, we note that every time we insert an element, at most one subtree for each node has changed. This means that we can just reuse the unchanged node. For instance, consider the array</p>
<p><span class="math display">\[ r = [1, 3, 2, 4, 5, 7, 6, 8] \]</span></p>
<p>At <span class="math inline">\(t=1\)</span>, we insert the first element into our value-based segment tree. To avoid confusion, we color edges pointing to the left child red.</p>
<?xml version="1.0" encoding="UTF-8" standalone="no" ?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.38.0 (20140413.2041)
 -->
<!-- Title: G Pages: 1 -->
<svg width="432pt" height="147pt" viewBox="0.00 0.00 432.00 146.58" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(0.563753 0.563753) rotate(0) translate(4 256)">
<title>G</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-256 762.293,-256 762.293,4 -4,4"></polygon>
<!-- a -->
<g id="node1" class="node"><title>a</title>
<ellipse fill="none" stroke="black" cx="378.646" cy="-234" rx="39.7935" ry="18"></ellipse>
<text text-anchor="middle" x="378.646" y="-230.3" font-family="Times,serif" font-size="14.00">[1, 8]: 1</text>
</g>
<!-- b -->
<g id="node2" class="node"><title>b</title>
<ellipse fill="none" stroke="black" cx="281.646" cy="-162" rx="39.7935" ry="18"></ellipse>
<text text-anchor="middle" x="281.646" y="-158.3" font-family="Times,serif" font-size="14.00">[1, 4]: 1</text>
</g>
<!-- a&#45;&gt;b -->
<g id="edge1" class="edge"><title>a-&gt;b</title>
<path fill="none" stroke="red" d="M358.075,-218.155C344.092,-208.064 325.411,-194.583 310.018,-183.474"></path>
<polygon fill="red" stroke="red" points="312.013,-180.598 301.855,-177.584 307.916,-186.274 312.013,-180.598"></polygon>
</g>
<!-- c -->
<g id="node3" class="node"><title>c</title>
<ellipse fill="none" stroke="black" cx="475.646" cy="-162" rx="39.7935" ry="18"></ellipse>
<text text-anchor="middle" x="475.646" y="-158.3" font-family="Times,serif" font-size="14.00">[5, 8]: 0</text>
</g>
<!-- a&#45;&gt;c -->
<g id="edge2" class="edge"><title>a-&gt;c</title>
<path fill="none" stroke="black" d="M399.218,-218.155C413.201,-208.064 431.882,-194.583 447.275,-183.474"></path>
<polygon fill="black" stroke="black" points="449.377,-186.274 455.438,-177.584 445.28,-180.598 449.377,-186.274"></polygon>
</g>
<!-- d -->
<g id="node4" class="node"><title>d</title>
<ellipse fill="none" stroke="black" cx="136.646" cy="-90" rx="39.7935" ry="18"></ellipse>
<text text-anchor="middle" x="136.646" y="-86.3" font-family="Times,serif" font-size="14.00">[1, 2]: 1</text>
</g>
<!-- b&#45;&gt;d -->
<g id="edge3" class="edge"><title>b-&gt;d</title>
<path fill="none" stroke="red" d="M255.388,-148.324C231.983,-137.025 197.544,-120.399 171.775,-107.959"></path>
<polygon fill="red" stroke="red" points="173.237,-104.778 162.71,-103.582 170.193,-111.082 173.237,-104.778"></polygon>
</g>
<!-- e -->
<g id="node5" class="node"><title>e</title>
<ellipse fill="none" stroke="black" cx="281.646" cy="-90" rx="39.7935" ry="18"></ellipse>
<text text-anchor="middle" x="281.646" y="-86.3" font-family="Times,serif" font-size="14.00">[3, 4]: 0</text>
</g>
<!-- b&#45;&gt;e -->
<g id="edge4" class="edge"><title>b-&gt;e</title>
<path fill="none" stroke="black" d="M281.646,-143.697C281.646,-135.983 281.646,-126.712 281.646,-118.112"></path>
<polygon fill="black" stroke="black" points="285.147,-118.104 281.646,-108.104 278.147,-118.104 285.147,-118.104"></polygon>
</g>
<!-- f -->
<g id="node6" class="node"><title>f</title>
<ellipse fill="none" stroke="black" cx="475.646" cy="-90" rx="39.7935" ry="18"></ellipse>
<text text-anchor="middle" x="475.646" y="-86.3" font-family="Times,serif" font-size="14.00">[5, 6]: 0</text>
</g>
<!-- c&#45;&gt;f -->
<g id="edge5" class="edge"><title>c-&gt;f</title>
<path fill="none" stroke="red" d="M475.646,-143.697C475.646,-135.983 475.646,-126.712 475.646,-118.112"></path>
<polygon fill="red" stroke="red" points="479.147,-118.104 475.646,-108.104 472.147,-118.104 479.147,-118.104"></polygon>
</g>
<!-- g -->
<g id="node7" class="node"><title>g</title>
<ellipse fill="none" stroke="black" cx="621.646" cy="-90" rx="39.7935" ry="18"></ellipse>
<text text-anchor="middle" x="621.646" y="-86.3" font-family="Times,serif" font-size="14.00">[7, 8]: 0</text>
</g>
<!-- c&#45;&gt;g -->
<g id="edge6" class="edge"><title>c-&gt;g</title>
<path fill="none" stroke="black" d="M502.086,-148.324C525.652,-137.025 560.329,-120.399 586.276,-107.959"></path>
<polygon fill="black" stroke="black" points="587.9,-111.062 595.404,-103.582 584.873,-104.75 587.9,-111.062"></polygon>
</g>
<!-- h -->
<g id="node8" class="node"><title>h</title>
<ellipse fill="none" stroke="black" cx="39.6465" cy="-18" rx="39.7935" ry="18"></ellipse>
<text text-anchor="middle" x="39.6465" y="-14.3" font-family="Times,serif" font-size="14.00">[1, 1]: 1</text>
</g>
<!-- d&#45;&gt;h -->
<g id="edge7" class="edge"><title>d-&gt;h</title>
<path fill="none" stroke="red" d="M116.075,-74.1548C102.092,-64.064 83.4109,-50.5825 68.018,-39.4743"></path>
<polygon fill="red" stroke="red" points="70.0126,-36.5975 59.8554,-33.5838 65.9163,-42.2738 70.0126,-36.5975"></polygon>
</g>
<!-- i -->
<g id="node9" class="node"><title>i</title>
<ellipse fill="none" stroke="black" cx="136.646" cy="-18" rx="39.7935" ry="18"></ellipse>
<text text-anchor="middle" x="136.646" y="-14.3" font-family="Times,serif" font-size="14.00">[2, 2]: 0</text>
</g>
<!-- d&#45;&gt;i -->
<g id="edge8" class="edge"><title>d-&gt;i</title>
<path fill="none" stroke="black" d="M136.646,-71.6966C136.646,-63.9827 136.646,-54.7125 136.646,-46.1124"></path>
<polygon fill="black" stroke="black" points="140.147,-46.1043 136.646,-36.1043 133.147,-46.1044 140.147,-46.1043"></polygon>
</g>
<!-- j -->
<g id="node10" class="node"><title>j</title>
<ellipse fill="none" stroke="black" cx="233.646" cy="-18" rx="39.7935" ry="18"></ellipse>
<text text-anchor="middle" x="233.646" y="-14.3" font-family="Times,serif" font-size="14.00">[3, 3]: 0</text>
</g>
<!-- e&#45;&gt;j -->
<g id="edge9" class="edge"><title>e-&gt;j</title>
<path fill="none" stroke="red" d="M270.271,-72.411C264.413,-63.8677 257.152,-53.2785 250.644,-43.7874"></path>
<polygon fill="red" stroke="red" points="253.482,-41.7379 244.94,-35.4699 247.709,-45.6966 253.482,-41.7379"></polygon>
</g>
<!-- k -->
<g id="node11" class="node"><title>k</title>
<ellipse fill="none" stroke="black" cx="330.646" cy="-18" rx="39.7935" ry="18"></ellipse>
<text text-anchor="middle" x="330.646" y="-14.3" font-family="Times,serif" font-size="14.00">[4, 4]: 0</text>
</g>
<!-- e&#45;&gt;k -->
<g id="edge10" class="edge"><title>e-&gt;k</title>
<path fill="none" stroke="black" d="M293.259,-72.411C299.239,-63.8677 306.652,-53.2785 313.295,-43.7874"></path>
<polygon fill="black" stroke="black" points="316.25,-45.6694 319.118,-35.4699 310.516,-41.6552 316.25,-45.6694"></polygon>
</g>
<!-- l -->
<g id="node12" class="node"><title>l</title>
<ellipse fill="none" stroke="black" cx="427.646" cy="-18" rx="39.7935" ry="18"></ellipse>
<text text-anchor="middle" x="427.646" y="-14.3" font-family="Times,serif" font-size="14.00">[5, 5]: 0</text>
</g>
<!-- f&#45;&gt;l -->
<g id="edge11" class="edge"><title>f-&gt;l</title>
<path fill="none" stroke="red" d="M464.271,-72.411C458.413,-63.8677 451.152,-53.2785 444.644,-43.7874"></path>
<polygon fill="red" stroke="red" points="447.482,-41.7379 438.94,-35.4699 441.709,-45.6966 447.482,-41.7379"></polygon>
</g>
<!-- m -->
<g id="node13" class="node"><title>m</title>
<ellipse fill="none" stroke="black" cx="524.646" cy="-18" rx="39.7935" ry="18"></ellipse>
<text text-anchor="middle" x="524.646" y="-14.3" font-family="Times,serif" font-size="14.00">[6, 6]: 0</text>
</g>
<!-- f&#45;&gt;m -->
<g id="edge12" class="edge"><title>f-&gt;m</title>
<path fill="none" stroke="black" d="M487.259,-72.411C493.239,-63.8677 500.652,-53.2785 507.295,-43.7874"></path>
<polygon fill="black" stroke="black" points="510.25,-45.6694 513.118,-35.4699 504.516,-41.6552 510.25,-45.6694"></polygon>
</g>
<!-- n -->
<g id="node14" class="node"><title>n</title>
<ellipse fill="none" stroke="black" cx="621.646" cy="-18" rx="39.7935" ry="18"></ellipse>
<text text-anchor="middle" x="621.646" y="-14.3" font-family="Times,serif" font-size="14.00">[7, 7]: 0</text>
</g>
<!-- g&#45;&gt;n -->
<g id="edge13" class="edge"><title>g-&gt;n</title>
<path fill="none" stroke="red" d="M621.646,-71.6966C621.646,-63.9827 621.646,-54.7125 621.646,-46.1124"></path>
<polygon fill="red" stroke="red" points="625.147,-46.1043 621.646,-36.1043 618.147,-46.1044 625.147,-46.1043"></polygon>
</g>
<!-- o -->
<g id="node15" class="node"><title>o</title>
<ellipse fill="none" stroke="black" cx="718.646" cy="-18" rx="39.7935" ry="18"></ellipse>
<text text-anchor="middle" x="718.646" y="-14.3" font-family="Times,serif" font-size="14.00">[8, 8]: 0</text>
</g>
<!-- g&#45;&gt;o -->
<g id="edge14" class="edge"><title>g-&gt;o</title>
<path fill="none" stroke="black" d="M642.218,-74.1548C656.201,-64.064 674.882,-50.5825 690.275,-39.4743"></path>
<polygon fill="black" stroke="black" points="692.377,-42.2738 698.438,-33.5838 688.28,-36.5975 692.377,-42.2738"></polygon>
</g>
</g>
</svg>

<p>At <span class="math inline">\(t=2\)</span>, we create a new root node <span class="math inline">\([1, 8]: 2\)</span>. But notice that instead of creating both child nodes of the root node, we can reuse the right child since it has not been altered. We do the same for all subsequent nodes. To make things clearer, we colored all newly created nodes blue. We have:</p>
<?xml version="1.0" encoding="UTF-8" standalone="no" ?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.38.0 (20140413.2041)
 -->
<!-- Title: G Pages: 1 -->
<svg width="432pt" height="130pt" viewBox="0.00 0.00 432.00 130.11" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(0.500409 0.500409) rotate(0) translate(4 256)">
<title>G</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-256 859.293,-256 859.293,4 -4,4"></polygon>
<!-- a -->
<g id="node1" class="node"><title>a</title>
<ellipse fill="none" stroke="black" cx="293.646" cy="-234" rx="39.7935" ry="18"></ellipse>
<text text-anchor="middle" x="293.646" y="-230.3" font-family="Times,serif" font-size="14.00">[1, 8]: 1</text>
</g>
<!-- b -->
<g id="node2" class="node"><title>b</title>
<ellipse fill="none" stroke="black" cx="257.646" cy="-162" rx="39.7935" ry="18"></ellipse>
<text text-anchor="middle" x="257.646" y="-158.3" font-family="Times,serif" font-size="14.00">[1, 4]: 1</text>
</g>
<!-- a&#45;&gt;b -->
<g id="edge1" class="edge"><title>a-&gt;b</title>
<path fill="none" stroke="red" d="M285.115,-216.411C280.918,-208.249 275.76,-198.22 271.052,-189.065"></path>
<polygon fill="red" stroke="red" points="274.053,-187.248 266.367,-179.956 267.828,-190.45 274.053,-187.248"></polygon>
</g>
<!-- c -->
<g id="node3" class="node"><title>c</title>
<ellipse fill="none" stroke="black" cx="499.646" cy="-162" rx="39.7935" ry="18"></ellipse>
<text text-anchor="middle" x="499.646" y="-158.3" font-family="Times,serif" font-size="14.00">[5, 8]: 0</text>
</g>
<!-- a&#45;&gt;c -->
<g id="edge2" class="edge"><title>a-&gt;c</title>
<path fill="none" stroke="black" d="M324.487,-222.52C360.391,-210.32 419.806,-190.13 459.337,-176.697"></path>
<polygon fill="black" stroke="black" points="460.59,-179.968 468.932,-173.437 458.338,-173.34 460.59,-179.968"></polygon>
</g>
<!-- d -->
<g id="node4" class="node"><title>d</title>
<ellipse fill="none" stroke="black" cx="160.646" cy="-90" rx="39.7935" ry="18"></ellipse>
<text text-anchor="middle" x="160.646" y="-86.3" font-family="Times,serif" font-size="14.00">[1, 2]: 1</text>
</g>
<!-- b&#45;&gt;d -->
<g id="edge3" class="edge"><title>b-&gt;d</title>
<path fill="none" stroke="red" d="M237.075,-146.155C223.092,-136.064 204.411,-122.583 189.018,-111.474"></path>
<polygon fill="red" stroke="red" points="191.013,-108.598 180.855,-105.584 186.916,-114.274 191.013,-108.598"></polygon>
</g>
<!-- e -->
<g id="node5" class="node"><title>e</title>
<ellipse fill="none" stroke="black" cx="257.646" cy="-90" rx="39.7935" ry="18"></ellipse>
<text text-anchor="middle" x="257.646" y="-86.3" font-family="Times,serif" font-size="14.00">[3, 4]: 0</text>
</g>
<!-- b&#45;&gt;e -->
<g id="edge4" class="edge"><title>b-&gt;e</title>
<path fill="none" stroke="black" d="M257.646,-143.697C257.646,-135.983 257.646,-126.712 257.646,-118.112"></path>
<polygon fill="black" stroke="black" points="261.147,-118.104 257.646,-108.104 254.147,-118.104 261.147,-118.104"></polygon>
</g>
<!-- f -->
<g id="node6" class="node"><title>f</title>
<ellipse fill="none" stroke="black" cx="524.646" cy="-90" rx="39.7935" ry="18"></ellipse>
<text text-anchor="middle" x="524.646" y="-86.3" font-family="Times,serif" font-size="14.00">[5, 6]: 0</text>
</g>
<!-- c&#45;&gt;f -->
<g id="edge5" class="edge"><title>c-&gt;f</title>
<path fill="none" stroke="red" d="M505.698,-144.055C508.512,-136.176 511.926,-126.617 515.077,-117.794"></path>
<polygon fill="red" stroke="red" points="518.409,-118.87 518.477,-108.275 511.817,-116.516 518.409,-118.87"></polygon>
</g>
<!-- g -->
<g id="node7" class="node"><title>g</title>
<ellipse fill="none" stroke="black" cx="718.646" cy="-90" rx="39.7935" ry="18"></ellipse>
<text text-anchor="middle" x="718.646" y="-86.3" font-family="Times,serif" font-size="14.00">[7, 8]: 0</text>
</g>
<!-- c&#45;&gt;g -->
<g id="edge6" class="edge"><title>c-&gt;g</title>
<path fill="none" stroke="black" d="M531.024,-150.971C569.456,-138.686 634.68,-117.839 677.207,-104.245"></path>
<polygon fill="black" stroke="black" points="678.512,-107.503 686.972,-101.124 676.381,-100.835 678.512,-107.503"></polygon>
</g>
<!-- h -->
<g id="node8" class="node"><title>h</title>
<ellipse fill="none" stroke="black" cx="39.6465" cy="-18" rx="39.7935" ry="18"></ellipse>
<text text-anchor="middle" x="39.6465" y="-14.3" font-family="Times,serif" font-size="14.00">[1, 1]: 1</text>
</g>
<!-- d&#45;&gt;h -->
<g id="edge7" class="edge"><title>d-&gt;h</title>
<path fill="none" stroke="red" d="M137.029,-75.3371C118.457,-64.5929 92.3864,-49.5107 71.8933,-37.6552"></path>
<polygon fill="red" stroke="red" points="73.6127,-34.6064 63.2042,-32.6284 70.1074,-40.6656 73.6127,-34.6064"></polygon>
</g>
<!-- i -->
<g id="node9" class="node"><title>i</title>
<ellipse fill="none" stroke="black" cx="136.646" cy="-18" rx="39.7935" ry="18"></ellipse>
<text text-anchor="middle" x="136.646" y="-14.3" font-family="Times,serif" font-size="14.00">[2, 2]: 0</text>
</g>
<!-- d&#45;&gt;i -->
<g id="edge8" class="edge"><title>d-&gt;i</title>
<path fill="none" stroke="black" d="M154.837,-72.055C152.135,-64.1762 148.858,-54.6165 145.833,-45.794"></path>
<polygon fill="black" stroke="black" points="149.124,-44.5996 142.569,-36.2753 142.502,-46.8699 149.124,-44.5996"></polygon>
</g>
<!-- j -->
<g id="node10" class="node"><title>j</title>
<ellipse fill="none" stroke="black" cx="233.646" cy="-18" rx="39.7935" ry="18"></ellipse>
<text text-anchor="middle" x="233.646" y="-14.3" font-family="Times,serif" font-size="14.00">[3, 3]: 0</text>
</g>
<!-- e&#45;&gt;j -->
<g id="edge9" class="edge"><title>e-&gt;j</title>
<path fill="none" stroke="red" d="M251.837,-72.055C249.135,-64.1762 245.858,-54.6165 242.833,-45.794"></path>
<polygon fill="red" stroke="red" points="246.124,-44.5996 239.569,-36.2753 239.502,-46.8699 246.124,-44.5996"></polygon>
</g>
<!-- k -->
<g id="node11" class="node"><title>k</title>
<ellipse fill="none" stroke="black" cx="330.646" cy="-18" rx="39.7935" ry="18"></ellipse>
<text text-anchor="middle" x="330.646" y="-14.3" font-family="Times,serif" font-size="14.00">[4, 4]: 0</text>
</g>
<!-- e&#45;&gt;k -->
<g id="edge10" class="edge"><title>e-&gt;k</title>
<path fill="none" stroke="black" d="M273.848,-73.4647C283.582,-64.1302 296.141,-52.0872 306.973,-41.7002"></path>
<polygon fill="black" stroke="black" points="309.695,-43.9393 314.491,-34.4918 304.85,-38.8868 309.695,-43.9393"></polygon>
</g>
<!-- l -->
<g id="node12" class="node"><title>l</title>
<ellipse fill="none" stroke="black" cx="524.646" cy="-18" rx="39.7935" ry="18"></ellipse>
<text text-anchor="middle" x="524.646" y="-14.3" font-family="Times,serif" font-size="14.00">[5, 5]: 0</text>
</g>
<!-- f&#45;&gt;l -->
<g id="edge11" class="edge"><title>f-&gt;l</title>
<path fill="none" stroke="red" d="M524.646,-71.6966C524.646,-63.9827 524.646,-54.7125 524.646,-46.1124"></path>
<polygon fill="red" stroke="red" points="528.147,-46.1043 524.646,-36.1043 521.147,-46.1044 528.147,-46.1043"></polygon>
</g>
<!-- m -->
<g id="node13" class="node"><title>m</title>
<ellipse fill="none" stroke="black" cx="621.646" cy="-18" rx="39.7935" ry="18"></ellipse>
<text text-anchor="middle" x="621.646" y="-14.3" font-family="Times,serif" font-size="14.00">[6, 6]: 0</text>
</g>
<!-- f&#45;&gt;m -->
<g id="edge12" class="edge"><title>f-&gt;m</title>
<path fill="none" stroke="black" d="M545.218,-74.1548C559.201,-64.064 577.882,-50.5825 593.275,-39.4743"></path>
<polygon fill="black" stroke="black" points="595.377,-42.2738 601.438,-33.5838 591.28,-36.5975 595.377,-42.2738"></polygon>
</g>
<!-- n -->
<g id="node14" class="node"><title>n</title>
<ellipse fill="none" stroke="black" cx="718.646" cy="-18" rx="39.7935" ry="18"></ellipse>
<text text-anchor="middle" x="718.646" y="-14.3" font-family="Times,serif" font-size="14.00">[7, 7]: 0</text>
</g>
<!-- g&#45;&gt;n -->
<g id="edge13" class="edge"><title>g-&gt;n</title>
<path fill="none" stroke="red" d="M718.646,-71.6966C718.646,-63.9827 718.646,-54.7125 718.646,-46.1124"></path>
<polygon fill="red" stroke="red" points="722.147,-46.1043 718.646,-36.1043 715.147,-46.1044 722.147,-46.1043"></polygon>
</g>
<!-- o -->
<g id="node15" class="node"><title>o</title>
<ellipse fill="none" stroke="black" cx="815.646" cy="-18" rx="39.7935" ry="18"></ellipse>
<text text-anchor="middle" x="815.646" y="-14.3" font-family="Times,serif" font-size="14.00">[8, 8]: 0</text>
</g>
<!-- g&#45;&gt;o -->
<g id="edge14" class="edge"><title>g-&gt;o</title>
<path fill="none" stroke="black" d="M739.218,-74.1548C753.201,-64.064 771.882,-50.5825 787.275,-39.4743"></path>
<polygon fill="black" stroke="black" points="789.377,-42.2738 795.438,-33.5838 785.28,-36.5975 789.377,-42.2738"></polygon>
</g>
<!-- a1 -->
<g id="node16" class="node"><title>a1</title>
<ellipse fill="none" stroke="blue" cx="426.646" cy="-234" rx="39.7935" ry="18"></ellipse>
<text text-anchor="middle" x="426.646" y="-230.3" font-family="Times,serif" font-size="14.00">[1, 8]: 2</text>
</g>
<!-- a1&#45;&gt;c -->
<g id="edge15" class="edge"><title>a1-&gt;c</title>
<path fill="none" stroke="black" d="M442.848,-217.465C452.582,-208.13 465.141,-196.087 475.973,-185.7"></path>
<polygon fill="black" stroke="black" points="478.695,-187.939 483.491,-178.492 473.85,-182.887 478.695,-187.939"></polygon>
</g>
<!-- b1 -->
<g id="node17" class="node"><title>b1</title>
<ellipse fill="none" stroke="blue" cx="354.646" cy="-162" rx="39.7935" ry="18"></ellipse>
<text text-anchor="middle" x="354.646" y="-158.3" font-family="Times,serif" font-size="14.00">[1, 4]: 2</text>
</g>
<!-- a1&#45;&gt;b1 -->
<g id="edge16" class="edge"><title>a1-&gt;b1</title>
<path fill="none" stroke="red" d="M410.667,-217.465C401.066,-208.13 388.679,-196.087 377.995,-185.7"></path>
<polygon fill="red" stroke="red" points="380.191,-182.953 370.581,-178.492 375.311,-187.972 380.191,-182.953"></polygon>
</g>
<!-- b1&#45;&gt;d -->
<g id="edge17" class="edge"><title>b1-&gt;d</title>
<path fill="none" stroke="red" d="M324.334,-150.062C290.878,-137.991 236.907,-118.517 200.158,-105.257"></path>
<polygon fill="red" stroke="red" points="201.34,-101.963 190.746,-101.861 198.965,-108.547 201.34,-101.963"></polygon>
</g>
<!-- e1 -->
<g id="node18" class="node"><title>e1</title>
<ellipse fill="none" stroke="blue" cx="354.646" cy="-90" rx="39.7935" ry="18"></ellipse>
<text text-anchor="middle" x="354.646" y="-86.3" font-family="Times,serif" font-size="14.00">[3, 4]: 1</text>
</g>
<!-- b1&#45;&gt;e1 -->
<g id="edge18" class="edge"><title>b1-&gt;e1</title>
<path fill="none" stroke="black" d="M354.646,-143.697C354.646,-135.983 354.646,-126.712 354.646,-118.112"></path>
<polygon fill="black" stroke="black" points="358.147,-118.104 354.646,-108.104 351.147,-118.104 358.147,-118.104"></polygon>
</g>
<!-- e1&#45;&gt;k -->
<g id="edge19" class="edge"><title>e1-&gt;k</title>
<path fill="none" stroke="black" d="M348.837,-72.055C346.135,-64.1762 342.858,-54.6165 339.833,-45.794"></path>
<polygon fill="black" stroke="black" points="343.124,-44.5996 336.569,-36.2753 336.502,-46.8699 343.124,-44.5996"></polygon>
</g>
<!-- j1 -->
<g id="node19" class="node"><title>j1</title>
<ellipse fill="none" stroke="blue" cx="427.646" cy="-18" rx="39.7935" ry="18"></ellipse>
<text text-anchor="middle" x="427.646" y="-14.3" font-family="Times,serif" font-size="14.00">[3, 3]: 1</text>
</g>
<!-- e1&#45;&gt;j1 -->
<g id="edge20" class="edge"><title>e1-&gt;j1</title>
<path fill="none" stroke="red" d="M370.848,-73.4647C380.582,-64.1302 393.141,-52.0872 403.973,-41.7002"></path>
<polygon fill="red" stroke="red" points="406.695,-43.9393 411.491,-34.4918 401.85,-38.8868 406.695,-43.9393"></polygon>
</g>
</g>
</svg>

<p>We repeat this until we have inserted every element from our original array and keep track of each root. Notice that in each insert, we only create one node at each layer, or <span class="math inline">\(\mathcal{O}(\log{}n)\)</span> nodes, and there is a total of <span class="math inline">\(n\)</span> insertions. As such, our space complexity is only <span class="math inline">\(\mathcal{O}(n\log{}n)\)</span>. After all the insertions are done, we can locate the root at each <span class="math inline">\(t\)</span> in constant time using a look-up table and query for the <span class="math inline">\(k^{th}\)</span> largest element from the start to a certain position in <span class="math inline">\(\mathcal{O}(\log{}n)\)</span>. We are now ready to take the final step and solve the problem completely.</p>
<p>For the final step, we notice that we can find the number of elements in the range <span class="math inline">\([l, r]\)</span> whose indices falls in range <span class="math inline">\(&lt;t_1, t_2&gt;\)</span> by doing a prefix sum. That is, we find number of elements in the range <span class="math inline">\([l, r]\)</span> in index-range <span class="math inline">\(&lt;1, t_2&gt;\)</span> and <span class="math inline">\(&lt;1, t_1-1&gt;\)</span> separately, then take their difference. A similar idea that solves the two subproblems can then be used again. The pseudocode (actually c++, again) below shows the query algorithm:</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp">
node nodes[N];

<span class="dt">int</span> find_kth(node n1, node n2, <span class="dt">int</span> k) {
    <span class="cf">if</span>(is_leaf(n)) <span class="cf">return</span> n.label;
    <span class="dt">int</span> t = n2.size() - n1.size();
    <span class="cf">if</span>(k &lt;= t) <span class="cf">return</span> find_kth(n1.right_child, n2.right_child, t);
    <span class="cf">else</span> <span class="cf">return</span> find_kth(n1.left_child, n2.left_child, k - t);
}

<span class="dt">int</span> main() {
    <span class="co">// process the nodes</span>
    <span class="dt">int</span> t1, t2, k;
    cin &gt;&gt; t1 &gt;&gt; t2 &gt;&gt; k;
    cout &lt;&lt; find_kth(nodes[t1 - <span class="dv">1</span>], nodes[t2], k);
}</code></pre></div>
<p>The remaining code will be posted when I recovered from the trauma of writing this post and the immense amount of homework. For any queries, feel free to email me at 18yluxu069i@students.ri.edu.sg.</p>
    </div>

</div>

                </div>
            </div>
        </div>
    </div>
</body>

</html>
